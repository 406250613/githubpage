<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é“²çŒ«ç ‚è®°å½•å™¨</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 28px;
      }

      .member-container {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 30px;
      }

      .member {
        flex: 1;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s ease;
      }

      .member:hover {
        transform: translateY(-2px);
      }

      .member h2 {
        color: #555;
        margin-bottom: 15px;
        font-size: 24px;
      }

      .days-display {
        font-size: 48px;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 20px;
      }

      .btn-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .input-group {
        display: flex;
        gap: 5px;
      }

      .days-input {
        flex: 1;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s ease;
      }

      .days-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .reason-input {
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        width: 100%;
        resize: vertical;
        min-height: 60px;
        margin-bottom: 10px;
        transition: all 0.2s ease;
      }

      .reason-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-add {
        background: #ff6b6b;
        color: white;
      }

      .btn-add:hover {
        background: #ff5252;
        transform: translateY(-1px);
      }

      .btn-complete {
        background: #4ecdc4;
        color: white;
      }

      .btn-complete:hover {
        background: #26a69a;
        transform: translateY(-1px);
      }

      .history {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .history h3 {
        color: #555;
        margin-bottom: 15px;
        font-size: 20px;
      }

      .history-list {
        max-height: 200px;
        overflow-y: auto;
        list-style: none;
      }

      .history-item {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        color: #666;
        font-size: 14px;
      }

      .history-item:last-child {
        border-bottom: none;
      }

      .clear-btn {
        width: 100%;
        margin-top: 20px;
        padding: 12px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .clear-btn:hover {
        background: #5a6268;
      }

      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      @media (max-width: 480px) {
        .member-container {
          flex-direction: column;
        }

        .days-display {
          font-size: 36px;
        }
      }

      /* çŠ¶æ€æç¤ºæ ·å¼ */
      .status {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }
    </style>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- <h1>ğŸ± é“²çŒ«ç ‚è®°å½•å™¨</h1> -->
      <h1>è®°å½•å™¨</h1>

      <div class="status" id="status">è¿æ¥ä¸­...</div>

      <div class="member-container">
        <div class="member">
          <h2>æˆå‘˜ A</h2>
          <div class="days-display" id="daysA">0</div>
          <div class="btn-group">
            <textarea
              class="reason-input"
              id="reasonA"
              placeholder="è¯·è¾“å…¥å¢åŠ æƒ©ç½šçš„åŸå› ..."
            ></textarea>
            <div class="input-group">
              <input
                type="number"
                class="days-input"
                id="inputA"
                placeholder="è¾“å…¥å¤©æ•°"
                min="1"
                max="30"
              />
              <button class="btn btn-add" onclick="addDays('A')">
                <span class="tooltip"
                  >ç¡®è®¤<span class="tooltiptext">å¢åŠ æƒ©ç½šå¤©æ•°</span></span
                >
              </button>
            </div>
            <button class="btn btn-complete" onclick="completeDay('A')">
              <span class="tooltip"
                >å·²å®Œæˆ<span class="tooltiptext">æ¸…é›¶æƒ©ç½šå¤©æ•°</span></span
              >
            </button>
          </div>
        </div>

        <div class="member">
          <h2>æˆå‘˜ B</h2>
          <div class="days-display" id="daysB">0</div>
          <div class="btn-group">
            <textarea
              class="reason-input"
              id="reasonB"
              placeholder="è¯·è¾“å…¥å¢åŠ æƒ©ç½šçš„åŸå› ..."
            ></textarea>
            <div class="input-group">
              <input
                type="number"
                class="days-input"
                id="inputB"
                placeholder="è¾“å…¥å¤©æ•°"
                min="1"
                max="30"
              />
              <button class="btn btn-add" onclick="addDays('B')">
                <span class="tooltip"
                  >ç¡®è®¤<span class="tooltiptext">å¢åŠ æƒ©ç½šå¤©æ•°</span></span
                >
              </button>
            </div>
            <button class="btn btn-complete" onclick="completeDay('B')">
              <span class="tooltip"
                >å·²å®Œæˆ<span class="tooltiptext">æ¸…é›¶æƒ©ç½šå¤©æ•°</span></span
              >
            </button>
          </div>
        </div>
      </div>

      <div class="history">
        <h3>ğŸ“‹ æ“ä½œè®°å½•</h3>
        <ul class="history-list" id="historyList"></ul>
      </div>

      <button class="clear-btn" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
    </div>

    <script>
      // ********** Supabaseé…ç½® **********
      // è¯·æ›¿æ¢ä¸ºä½ çš„Supabaseé¡¹ç›®é…ç½®
      const SUPABASE_URL = "https://lrkbyknhvpuywruyofqj.supabase.co"; //'YOUR_SUPABASE_URL';
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxya2J5a25odnB1eXdydXlvZnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDU1NTYsImV4cCI6MjA4NDk4MTU1Nn0.v0BnL8yOZzjKEwgPybrZ6XtDi5k5LZI4W5gj8NOpNuc"; //'YOUR_SUPABASE_ANON_KEY';

      // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
      );

      // æ•°æ®é”®å
      const DATA_KEY = "litterBoxData";
      let isConnected = false;

      // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
      function updateStatus(connected) {
        isConnected = connected;
        const statusElement = document.getElementById("status");
        if (connected) {
          statusElement.textContent = "å·²è¿æ¥åˆ°æœåŠ¡å™¨ âœ…";
          statusElement.className = "status connected";
        } else {
          statusElement.textContent = "æœªè¿æ¥åˆ°æœåŠ¡å™¨ âŒ";
          statusElement.className = "status disconnected";
        }
      }

      // åˆå§‹åŒ–æ•°æ®
      async function initData() {
        try {
          // å°è¯•ä»Supabaseè·å–æ•°æ® - å°è¯•ä½¿ç”¨ä¸åŒçš„è¡¨åï¼ˆå¤æ•°å½¢å¼ï¼‰
          const { data, error } = await supabaseClient
            .from("litter_box_datas")
            .select("*")
            .eq("key", DATA_KEY)
            .single();

          if (error) {
            console.log("è·å–æ•°æ®é”™è¯¯:", error);

            // å°è¯•åˆ›å»ºæ•°æ®ï¼ˆä½¿ç”¨æ›´ç®€å•çš„ç»“æ„ï¼‰
            const initialData = {
              A: 0,
              B: 0,
              history: [],
            };

            // å°è¯•ç›´æ¥å­˜å‚¨æ•´ä¸ªæ•°æ®ï¼Œä¸åµŒå¥—
            const { error: insertError } = await supabaseClient
              .from("litter_box_datas")
              .insert({
                ...initialData,
                key: DATA_KEY,
              });

            if (insertError) {
              console.error("æ’å…¥æ•°æ®å¤±è´¥:", insertError);
              throw insertError;
            }

            updateDisplay(initialData);
          } else {
            // æ£€æŸ¥æ•°æ®ç»“æ„
            if (data && typeof data === "object") {
              // å¦‚æœæ•°æ®æ˜¯ç›´æ¥å­˜å‚¨çš„ï¼ˆä¸æ˜¯åµŒå¥—åœ¨dataå­—æ®µä¸­ï¼‰
              const displayData = {
                A: data.A || 0,
                B: data.B || 0,
                history: Array.isArray(data.history) ? data.history : [],
              };
              updateDisplay(displayData);
            } else {
              updateDisplay(data.data || { A: 0, B: 0, history: [] });
            }
          }

          updateStatus(true);
        } catch (error) {
          console.error("åˆå§‹åŒ–æ•°æ®å¤±è´¥:", error);
          updateStatus(false);

          // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
          if (!localStorage.getItem(DATA_KEY)) {
            const initialData = {
              A: 0,
              B: 0,
              history: [],
            };
            localStorage.setItem(DATA_KEY, JSON.stringify(initialData));
            updateDisplay(initialData);
          } else {
            const localData = JSON.parse(localStorage.getItem(DATA_KEY));
            updateDisplay(localData);
          }
        }
      }

      // è·å–æ•°æ®
      async function getData() {
        try {
          const { data, error } = await supabaseClient
            .from("litter_box_datas")
            .select("*")
            .eq("key", DATA_KEY)
            .single();

          if (error) throw error;

          updateStatus(true);

          // å¤„ç†ä¸åŒçš„æ•°æ®ç»“æ„
          if (data && typeof data === "object") {
            // å¦‚æœæ•°æ®æ˜¯ç›´æ¥å­˜å‚¨çš„ï¼ˆä¸æ˜¯åµŒå¥—åœ¨dataå­—æ®µä¸­ï¼‰
            return {
              A: data.A || 0,
              B: data.B || 0,
              history: Array.isArray(data.history) ? data.history : [],
            };
          }
          return data.data || { A: 0, B: 0, history: [] };
        } catch (error) {
          console.error("è·å–æ•°æ®å¤±è´¥:", error);
          updateStatus(false);

          // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
          return JSON.parse(
            localStorage.getItem(DATA_KEY) ||
              JSON.stringify({
                A: 0,
                B: 0,
                history: [],
              }),
          );
        }
      }

      // ä¿å­˜æ•°æ®
      async function saveData(data) {
        try {
          const { error } = await supabaseClient
            .from("litter_box_datas")
            .upsert(
              {
                ...data,
                key: DATA_KEY,
              },
              {
                onConflict: "key",
              },
            );

          if (error) throw error;

          updateStatus(true);

          // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
          localStorage.setItem(DATA_KEY, JSON.stringify(data));
        } catch (error) {
          console.error("ä¿å­˜æ•°æ®å¤±è´¥:", error);
          updateStatus(false);

          // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
          localStorage.setItem(DATA_KEY, JSON.stringify(data));
        }
      }

      // æ›´æ–°æ˜¾ç¤º
      function updateDisplay(data) {
        document.getElementById("daysA").textContent = data.A;
        document.getElementById("daysB").textContent = data.B;
        updateHistory(data);
      }

      // æ›´æ–°å†å²è®°å½•
      function updateHistory(data) {
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = "";

        // ç¡®ä¿historyæ˜¯æ•°ç»„
        const historyArray = Array.isArray(data.history) ? data.history : [];

        // åªæ˜¾ç¤ºæœ€è¿‘20æ¡è®°å½•
        const recentHistory = historyArray.slice(-20).reverse();

        recentHistory.forEach((item) => {
          const li = document.createElement("li");
          li.className = "history-item";
          // å¤„ç†itemå¯èƒ½æ˜¯å¯¹è±¡çš„æƒ…å†µ
          li.textContent =
            typeof item === "object" ? JSON.stringify(item) : item;
          historyList.appendChild(li);
        });
      }

      // æ·»åŠ æ“ä½œè®°å½•
      function addHistory(action) {
        const now = new Date();
        const timestamp = now.toLocaleString("zh-CN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        return `${timestamp} - ${action}`;
      }

      // å¢åŠ å¤©æ•°
      async function addDays(member) {
        const input = document.getElementById(`input${member}`);
        const reasonInput = document.getElementById(`reason${member}`);
        const days = parseInt(input.value);
        const reason = reasonInput.value.trim() || "æœªè¯´æ˜åŸå› ";

        if (isNaN(days) || days < 1) {
          alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°ï¼ˆè‡³å°‘1å¤©ï¼‰");
          return;
        }

        const data = await getData();
        data[member] += days;

        // è·å–å½“å‰æ—¥æœŸï¼ˆä»…æ—¥æœŸï¼Œä¸å«æ—¶é—´ï¼‰
        const now = new Date();
        const currentDate = now.toLocaleDateString("zh-CN", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });

        data.history.push(
          addHistory(
            `${currentDate} - ${member} å¢åŠ ${days}å¤©æƒ©ç½š | åŸå› ï¼š${reason}`,
          ),
        );
        await saveData(data);
        updateDisplay(data);

        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = "";
        reasonInput.value = "";
      }

      // å®Œæˆå½“å¤©ï¼ˆæ¸…é›¶å¤©æ•°ï¼‰
      async function completeDay(member) {
        const data = await getData();
        if (data[member] > 0) {
          // äºŒæ¬¡éªŒè¯
          if (confirm(`ç¡®å®šè¦æ¸…é›¶${member}çš„æ‰€æœ‰æƒ©ç½šå¤©æ•°å—ï¼Ÿ`)) {
            const clearedDays = data[member];
            data[member] = 0;

            // è·å–å½“å‰æ—¥æœŸï¼ˆä»…æ—¥æœŸï¼Œä¸å«æ—¶é—´ï¼‰
            const now = new Date();
            const currentDate = now.toLocaleDateString("zh-CN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });

            data.history.push(
              addHistory(
                `${currentDate} - ${member} æ¸…é›¶æƒ©ç½šå¤©æ•°ï¼ˆå…±${clearedDays}å¤©ï¼‰`,
              ),
            );
            await saveData(data);
            updateDisplay(data);
          }
        }
      }

      // æ¸…ç©ºæ‰€æœ‰è®°å½•
      async function clearAll() {
        // äºŒæ¬¡éªŒè¯ - æ›´ä¸¥æ ¼çš„ç¡®è®¤
        if (
          confirm(
            "è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼ŒåŒ…æ‹¬æƒ©ç½šå¤©æ•°å’Œå†å²è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
          )
        ) {
          const initialData = {
            A: 0,
            B: 0,
            history: [],
          };
          await saveData(initialData);
          updateDisplay(initialData);
        }
      }

      // ç›‘å¬æ•°æ®å˜åŒ–ï¼ˆå®æ—¶åŒæ­¥ï¼‰
      function setupRealtimeSubscription() {
        const channel = supabaseClient
          .channel("litter_box_data_changes")
          .on(
            "postgres_changes",
            {
              event: "*",
              schema: "public",
              table: "litter_box_data",
              filter: `key=eq.${DATA_KEY}`,
            },
            async (payload) => {
              console.log("æ•°æ®å˜åŒ–:", payload);
              // æ•°æ®å˜åŒ–æ—¶é‡æ–°è·å–å¹¶æ›´æ–°æ˜¾ç¤º
              const latestData = await getData();
              updateDisplay(latestData);
            },
          )
          .subscribe();
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.onload = async function () {
        await initData();
        setupRealtimeSubscription();
      };
    </script>
  </body>
</html>
